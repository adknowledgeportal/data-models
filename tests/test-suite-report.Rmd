---
title: "Test Suite Report"
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

test_reaction <- function(pass) {
  if(is.na(pass)) { 
    ":zzz:" # potentially skipped tests
  } else if(pass) {
    ":white_check_mark:" 
  } else { 
    ":x:"
  }
}

md_link <- function (url) {
  if(length(url)) paste0("[template link]", "(",url,")") else ""
}
```

## Template Generation

The following manifest templates had at least one dependency with changes detected:

```{r parse-generation-logs, echo=FALSE}
gen_logs <- list.files("./logs", full.names = TRUE)
templates <- gsub("_log", "", basename(gen_logs))
gen_test_results <- lapply(gen_logs, readLines)
gen_test_links <- sapply(gen_test_results, md_link)
gen_test_reaction <- sapply(lengths(gen_test_results), test_reaction) 
gen_report <- data.frame(template = templates, 
                         result = gen_test_reaction, 
                         link = gen_test_links)
knitr::kable(gen_report)
```

```{r include = FALSE}
# dynamically create changed_manifests.json file based on templates list
dca_config_df <- jsonlite::fromJSON(here("dca-template-config.json"))
changed_manifests_df <- dca_config_df[!(dca_config_df$schema_name %in% templates)]
jsonlite::write_json(changed_manifests_df, "changed-manifests.json", pretty = TRUE, auto_unbox = TRUE)
cat(getwd()) # see what the working directory is since JSON isn't being parsed
```

## :construction: Manifest Validation - COMING SOON

```{r parse-validation-logs, echo=FALSE, eval = FALSE}

# don't evaluate for now
pass <- "Your manifest has been validated successfully."
config <- jsonlite::read_json("validate/config.json")
df <- lapply(config$tests, `[`, c("manifest", "expect_pass", "expectation"))
df <- Reduce(rbind.data.frame, df)
val_logs <- list.files("validate/logs", full.names = TRUE)
val_results <- lapply(val_logs, readLines)
val_pass <- data.frame(
  manifest = gsub(".txt", ".csv", basename(val_logs)),
  pass = sapply(val_results, function(x) any(grepl(pass, x))))
val_report <- merge(df, val_pass, by = "manifest", all.x = TRUE)
val_report$result <- sapply(val_report$expect_pass == val_report$pass, test_reaction)
knitr::kable(val_report[, c("manifest", "result", "expectation")])
```
