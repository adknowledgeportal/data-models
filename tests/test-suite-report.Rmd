---
title: "Test Suite Report"
output:
  github_document:
    html_preview: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

test_reaction <- function(pass) {
  if(is.na(pass)) { 
    ":zzz:" # potentially skipped tests
  } else if(pass) {
    ":white_check_mark:" 
  } else { 
    ":x:"
  }
}

md_link <- function (url) {
  if(length(url)) paste0("[template link]", "(",url,")") else ""
}
```

## Template Generation

The following manifest templates had at least one dependency with changes detected:

```{r parse-generation-logs, echo=FALSE}
gen_logs <- list.files("./logs", full.names = TRUE)
templates <- gsub("_log", "", basename(gen_logs))
gen_test_results <- lapply(gen_logs, readLines)
gen_test_links <- sapply(gen_test_results, md_link)
gen_test_reaction <- sapply(lengths(gen_test_results), test_reaction) 
gen_report <- data.frame(template = templates, 
                         result = gen_test_reaction, 
                         link = gen_test_links)
knitr::kable(gen_report)
```

```{r include = TRUE}
# dynamically create changed_manifests.json file based on templates list
# read json into df
dca_config_df <- jsonlite::read_json("https://raw.githubusercontent.com/adknowledgeportal/data-models/refs/heads/main/dca-template-config.json", simplifyVector = TRUE)
dca_config_df = as.data.frame(dca_config_df)
# filter df to include changed manifest information based on the templates list in the previous chunk
changed_manifests_df <- dca_config_df[dca_config_df[["manifest_schemas.schema_name"]] %in% templates, ]
# remove the manifest_schemas prefix from cols
names(changed_manifests_df) <- sub("^manifest_schemas\\.", "", names(changed_manifests_df))
changed_manifests_df <- changed_manifests_df[ , !(names(changed_manifests_df) %in% c("service_version", "schema_version"))]
schemas_list <- lapply(seq_len(nrow(changed_manifests_df)), function(i) as.list(changed_manifests_df[i, ]))
output <- list(
  manifest_schemas = schemas_list,
  service_version = "v23.1.1",
  schema_version = ""
)

# get path to file in repo root to overwrite it
repo_root <- tempdir()
json_filename <- "changed-manifests.json"
temp_path <- paste0(repo_root, "/", json_filename)
jsonlite::write_json(output, temp_path, pretty = TRUE, auto_unbox = TRUE)
cat(temp_path, "\n")
```

## :construction: Manifest Validation - COMING SOON

```{r parse-validation-logs, echo=FALSE, eval = FALSE}

# don't evaluate for now
pass <- "Your manifest has been validated successfully."
config <- jsonlite::read_json("validate/config.json")
df <- lapply(config$tests, `[`, c("manifest", "expect_pass", "expectation"))
df <- Reduce(rbind.data.frame, df)
val_logs <- list.files("validate/logs", full.names = TRUE)
val_results <- lapply(val_logs, readLines)
val_pass <- data.frame(
  manifest = gsub(".txt", ".csv", basename(val_logs)),
  pass = sapply(val_results, function(x) any(grepl(pass, x))))
val_report <- merge(df, val_pass, by = "manifest", all.x = TRUE)
val_report$result <- sapply(val_report$expect_pass == val_report$pass, test_reaction)
knitr::kable(val_report[, c("manifest", "result", "expectation")])
```
