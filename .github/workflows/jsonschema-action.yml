name: Generate JSON Schema

on:
  pull_request:
    types:
      - opened
      - synchronize
      - labeled
    branches:
      - "main"
    paths:
      - "modules/**"
      - "AD.model.csv"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.triggering_actor }}
  cancel-in-progress: true

jobs:
  generate-schemas:
    runs-on: ubuntu-latest
    if: github.triggering_actor != 'commit-to-main-bot-adkp[bot]'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate JSON Schemas
        id: generate
        uses: Sage-Bionetworks-Actions/generate-jsonschema@v0.0.2
        with:
          data-model-source: ./AD.model.csv
          data-model-labels: "display_label"

      - name: Upload schemas as artifacts
        uses: actions/upload-artifact@v4
        if: steps.generate.outputs.schemas != ''
        with:
          name: json-schemas
          path: ${{ steps.generate.outputs.schemas }}
          if-no-files-found: warn

      - name: Format Schema Report
        id: format
        run: |
          python - <<'PYTHON'
          import json
          import sys

          schemas = json.loads('''${{ steps.generate.outputs.schemas-json }}''')

          # Build markdown report with collapsible sections
          report = "## Generated JSON Schemas\n\n"
          report += f"**Total Schemas Generated:** {len(schemas)}\n\n"

          if len(schemas) == 0:
              report += "No schemas were generated.\n"
          else:
              # Create a summary table
              report += "### Summary\n\n"
              report += "| Schema Name | Schema ID | Properties Count |\n"
              report += "|-------------|-----------|------------------|\n"

              for schema in schemas:
                  schema_name = schema.get('title', 'Unnamed Schema')
                  schema_id = schema.get('$id', 'N/A')
                  properties = schema.get('properties', {})
                  prop_count = len(properties)
                  report += f"| {schema_name} | `{schema_id}` | {prop_count} |\n"

              report += "\n### Detailed Schema Information\n\n"

              # Add detailed information for each schema
              for schema in schemas:
                  schema_name = schema.get('title', 'Unnamed Schema')
                  schema_id = schema.get('$id', 'N/A')
                  schema_description = schema.get('description', 'No description available')

                  report += f"<details>\n<summary><strong>{schema_name}</strong></summary>\n\n"
                  report += f"**Schema ID:** `{schema_id}`\n\n"
                  report += f"**Description:** {schema_description}\n\n"

                  # Add properties summary
                  properties = schema.get('properties', {})
                  required_props = schema.get('required', [])

                  if properties:
                      report += "**Properties:**\n\n"
                      report += "| Property | Type | Required |\n"
                      report += "|----------|------|----------|\n"
                      for prop_name, prop_def in properties.items():
                          prop_type = prop_def.get('type', 'any')
                          is_required = 'âœ“' if prop_name in required_props else ''
                          report += f"| `{prop_name}` | {prop_type} | {is_required} |\n"

                  report += "\n</details>\n\n"

          # Write to file
          with open('schema-report.md', 'w') as f:
              f.write(report)
          PYTHON

      - name: Comment PR with Schema Summary
        uses: mshick/add-pr-comment@v2
        with:
          message-path: schema-report.md
          message-id: jsonschema-generation
